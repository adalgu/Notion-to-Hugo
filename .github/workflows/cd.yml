 name: CD

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 * * * *" # run every hour

jobs:
  cd:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "latest"
          extended: true

      - name: Build Hugo
        run: |
          # Hugo 빌드 시도
          hugo || true  # 오류가 발생해도 계속 진행

          # 빌드 결과 확인
          if [ -d "public" ]; then
            echo "Hugo build completed with some files"
            
            # 오류 로그 저장
            if [ -f "hugo_error.log" ]; then
              echo "Build completed with errors. Check hugo_error.log for details."
              
              # 오류 로그를 이슈로 생성
              if [ "${{ github.event_name }}" == "push" ]; then
                title="Hugo Build Errors - $(date '+%Y-%m-%d')"
                body="Hugo build completed with errors. The following files need attention:"
                body+=$'\n```\n'
                body+=$(cat hugo_error.log)
                body+=$'\n```\n'
                
                gh issue create --title "$title" --body "$body" || true
              fi
            fi
          else
            echo "Hugo build failed completely"
            exit 1
          fi

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.PERSONAL_TOKEN }} # personal access token 사용
          external_repository: adalgu/adalgu.github.io # 배포할 저장소
          publish_branch: gh-pages # 배포할 브랜치
          publish_dir: ./public
          commit_message: ${{ github.event.head_commit.message }}
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
